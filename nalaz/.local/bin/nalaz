#!/usr/bin/env bash
# nalaz: FZF-based interactive package manager for Nala

set -e

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check dependencies
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for cmd in nala fzf; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "âŒ $cmd not installed"
    exit 1
  }
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Parse arguments
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MODE="${1:--h}" # default to install if no argument

if [[ "$MODE" == "-h" || "$MODE" == "--help" ]]; then
  cat <<EOF
Usage: nalaz [mode]

Modes:
  install     Search and install packages (default)
  remove      Remove installed packages
  -h, --help  Show this help message

Usage inside fzf:
  TAB   Mark/unmark multiple packages
  ENTER Confirm selection
EOF
  exit 0
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Build package list depending on mode
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "$MODE" == "install" ]]; then
  LIST_CMD="nala search '' 2>/dev/null | awk '!/^[â””â”œâ”€â”‚]/ && NF {print \$1}'"
  ACTION="install"
elif [[ "$MODE" == "remove" ]]; then
  LIST_CMD="nala list --installed 2>/dev/null | awk '!/^[[â””â”œâ”€â”‚]/ && NF {print \$1}'"
  ACTION="remove"
else
  echo "âŒ Unknown mode: $MODE"
  echo "Use nalaz -h for help"
  exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Run fzf for package selection
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pkgs=$(eval "$LIST_CMD" | fzf \
  --multi \
  --ansi --reverse \
  --border=rounded \
  --header="ğŸ”  Select packages â€” TAB to mark, ENTER to $ACTION" \
  --prompt="nalaz> " \
  --preview="nala show {} --color 2>/dev/null" \
  --preview-window=right:60%:wrap)

[[ -z "$pkgs" ]] && {
  echo "No packages selected"
  exit 0
}

echo -e "\nğŸ“¦ Selected:\n$pkgs\n"
read -p "Proceed with nala $ACTION? [Y/n] " -r c
[[ $c =~ ^[Nn]$ ]] && exit 0

sudo nala "$ACTION" $pkgs
